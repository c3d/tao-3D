#!/bin/sh
# *****************************************************************************
#  tbl_wrap                                                         Tao project
# *****************************************************************************
#
#   File Description:
#
#     Create a C++ skeleton to interface C code with XLR,
#     e.g. to implement new XLR primitives
#
#
#
#
#
#
#
#
# *****************************************************************************
# This software is licensed under the GNU General Public License v3
# See file COPYING for details.
#  (C) 1992-2010 Christophe de Dinechin <christophe@taodyne.com>
#  (C) 2010 Jérôme Forissier <jerome@taodyne.com>
#  (C) 2010 Catherine Burvelle <cathy@taodyne.com>
#  (C) 2010 Lionel Schaffhauser <lionel@taodyne.com>
#  (C) 2010 Taodyne SAS
# *****************************************************************************

usage() {
    echo "Usage: $0 -o <outfile> <infile>"
    echo ""
    echo "Generate a C++ skeleton to implement new XLR primitives."
    echo "Example: $0 -o example_wrap.cpp example.tbl"
}

if [ $# = 0 ] ; then
    usage
	exit 1
fi

while [ "$1" ]
do
    if [ "$1" = "-o" ]; then
        OUT="$2"
        if [ -z "$OUT" ] ; then
            echo "$0: $1: missing file name"
            exit 1
        fi
        shift 2
    elif [ "$1" = "-h" ]; then
        usage
        exit 0
    else
        IN=$1
        MODNAME=$(basename $IN .tbl)
        shift
    fi
done

DATE=`date`

cat >$OUT << __EOF__
/*
 * Generated by $0 from $IN
 * $DATE
 */
#include "opcodes.h"
#include "types.h"
#include "runtime.h"
#include "options.h"
#include "main.h"
#include "traces.h"
#include "tao/module_api.h"
#include "$MODNAME.h"
#include <iostream>

/*
 * Record the version of the API this module is compiled with
 * (for runtime compatibility check)
 */
DLL_PUBLIC
XL::Version module_api_version = TAO_MODULE_API_CURRENT;

using namespace XL;

#include "opcodes_declare.h"
#include "$IN"

int enter_symbols(XL::Context *context)
{
#ifdef XL_TRACE_INSTNAME
    XL_INIT_TRACES();
#endif
#include "opcodes_define.h"
#include "$IN"
    return 0;
}


int delete_symbols(XL::Context * /*context*/)
{
#include "opcodes_delete.h"
#include "$IN"
    return 0;
}
__EOF__
